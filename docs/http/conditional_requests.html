<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-http/conditional_requests">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-rc.1">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Hi! 我是元玉鹏 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Hi! 我是元玉鹏 Atom Feed"><title data-rh="true">HTTP 条件请求 | Hi! 我是元玉鹏</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://yuanyp8.github.io/docs/http/conditional_requests"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="keywords" content="yuanyp8, wiki, blog, c, c++, docker, python, linux"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="HTTP 条件请求 | Hi! 我是元玉鹏"><meta data-rh="true" name="description" content="&amp;nbsp;"><meta data-rh="true" property="og:description" content="&amp;nbsp;"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://yuanyp8.github.io/docs/http/conditional_requests"><link data-rh="true" rel="alternate" href="https://yuanyp8.github.io/docs/http/conditional_requests" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://yuanyp8.github.io/docs/http/conditional_requests" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ae68c9db.css">
<link rel="preload" href="/assets/js/runtime~main.47731b22.js" as="script">
<link rel="preload" href="/assets/js/main.6c8dd19e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><div class="announcementBar_mb4j" style="background-color:#fafbfc;color:#091E42" role="banner"><div class="announcementBarContent_xLdY">🚀 如果你觉得还不错, 就给一个 ⭐️ Start 吧 ~ <a target="_blank" rel="noopener noreferrer" href="https://github.com/yuanyp8/yuanyp8.github.io/tree/master/">Click here</a> </div></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Yuanyp8 Wiki</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">🖐Docs</a><a class="navbar__item navbar__link" href="/work">📗Work</a><a class="navbar__item navbar__link" href="/life">🚴Life</a><a class="navbar__item navbar__link" href="/blog">❤随笔</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/yuanyp8/yuanyp8.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"><b>Yuanyp8 Wiki</b></a><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs">互联网冲浪指南</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/docker-cookbook">Docker Cookbook</a><button aria-label="打开/收起侧边栏菜单「Docker Cookbook」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/http-protocol">HTTP Protocol</a><button aria-label="打开/收起侧边栏菜单「HTTP Protocol」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/guide">HTTP 协议概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/evolution">HTTP 发展历程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/message">HTTP Message 简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/session">一个典型的HTTP 会话</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/Connection_management">HTTP/1.x 的连接管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/protocol_upgrade">HTTP协议升级机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/uri">URI 简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/mime">MIME 简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/mime_common_types">常见 MIME 类型列表</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/www">www 或非 www URL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/cors">跨源资源共享（CORS）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/auth">auth</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/caching">HTTP 缓存</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/compression">HTTP 协议中的数据压缩</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/http/conditional_requests">HTTP 条件请求</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/content_negotiation">内容协商</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/cookies">HTTP Cookie</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/range_requests">HTTP 请求范围</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/redirections">HTTP 的重定向</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/headers">附录 headers</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/附录-request-methods">附录: request methods</a><button aria-label="打开/收起侧边栏菜单「附录: request methods」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/http/status">附录 Response Status Code</a></li></ul></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>HTTP 条件请求</h1></header><img loading="lazy" class="Badges img_ev3q" src="https://img.shields.io/badge/author-yuanyp8-yellowgreen"> <img loading="lazy" class="Badges img_ev3q" src="https://img.shields.io/badge/reference-mozilla-lightgrey"><br> <br><p>在 HTTP 协议中有一个“<strong>条件式请求</strong>”的概念，在这类请求中，请求的结果，甚至请求成功的状态，都会随着验证器与受影响资源的比较结果的变化而变化。这类请求可以用来验证缓存的有效性，省去不必要的控制手段，以及验证文件的完整性，例如在断点续传的场景下或者在上传或者修改服务器端的文件的时候避免更新丢失问题。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="基本原理">基本原理<a class="hash-link" href="#基本原理" title="标题的直接链接">​</a></h2><p>在 HTTP 协议中，条件请求指的是请求的执行结果会因特定首部的值不同而不同。这些首部规定了请求的前置条件，请求结果则视条件匹配与否而有所不同。</p><p>请求引发的不同的反应取决于请求所使用的方法，以及组成前置条件首部集合：</p><ul><li>对于安全（<a href="https://developer.mozilla.org/zh-CN/docs/Glossary/Safe" target="_blank" rel="noopener noreferrer">safe</a>）方法来说，例如 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/GET" target="_blank" rel="noopener noreferrer"><code>GET</code></a>，通常用来获取文件，条件请求可以被用来限定仅在满足条件的情况下返回文件。这样可以节省带宽。</li><li>对于非安全（<a href="https://developer.mozilla.org/zh-CN/docs/Glossary/Safe" target="_blank" rel="noopener noreferrer">unsafe</a>）方法来说，例如 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/PUT" target="_blank" rel="noopener noreferrer"><code>PUT</code></a> 方法，通常用来上传文件，条件请求可以被用来限定仅在满足文件的初始版本与服务器上的版本相同的条件下才会将其上传。</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="验证器">验证器<a class="hash-link" href="#验证器" title="标题的直接链接">​</a></h2><p>所有的条件请求首部都是试图去检测服务器上存储的资源是否与某一特定版本相匹配。为了达到这个目的，条件请求需要指明资源的版本。由于逐个字节去比较完整资源是不切实际的，况且这也并非总是想要的结果，所以在请求中会传递一个描述资源版本的值。这些值称为“验证器”，并且分为两大类：</p><ul><li>文件的最后修改时间，即 <em>last-modified</em> （最后修改）时间。</li><li>一个意义模糊的字符串，指代一个独一无二的版本，称为“实体标签”，或者 <em>etag 。</em></li></ul><p>比较同一份资源的不同版本有一定的技巧性：取决于上下文环境的不同，有两种不同的等值检查（<em>equality checks</em>）类型：</p><ul><li>强验证类型（<em>Strong validation</em>）应用于需要逐个字节相对应的情况，例如需要进行断点续传的时候。</li><li>弱验证类型（<em>Weak validation</em>）应用于用户代理只需要确认资源内容相同即可。即便是有细微差别也可以接受，比如显示的广告不同，或者是页脚的时间不同。</li></ul><p>验证类型与验证器的类型是相互独立的。 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Last-Modified" target="_blank" rel="noopener noreferrer"><code>Last-Modified</code></a> 和 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/ETag" target="_blank" rel="noopener noreferrer"><code>ETag</code></a> 首部均可应用于两种验证类型，尽管在服务器端实现的复杂程度可能会有所不同。HTTP 协议默认使用强验证类型，可以指定何时使用弱验证类型。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="强验证类型">强验证类型<a class="hash-link" href="#强验证类型" title="标题的直接链接">​</a></h3><p>强验证类型的作用在于确保要比较的资源与其相比较的对象之间每一个字节都相同。对于有些首部来说需要明确指定该验证类型，而对于另外一些来说则是默认值就是强验证类型。强验证类型的要求相当严格，在服务器层面来说可能较难保证。但是它确保了数据在任何时候都没有缺损，有时候则需要以牺牲性能为代价。</p><p>使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Last-Modified" target="_blank" rel="noopener noreferrer"><code>Last-Modified</code></a> 首部很难为强验证类型提供一个唯一标识。通常这是由 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/ETag" target="_blank" rel="noopener noreferrer"><code>ETag</code></a> 首部来完成的，该首部可以提供使用 MD5 算法获取的资源（或其衍生品）的散列值。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="弱验证类型">弱验证类型<a class="hash-link" href="#弱验证类型" title="标题的直接链接">​</a></h3><p>弱验证类型与强验证类型不同，因为它会把内容相同的两份文件看做是一样的。例如，使用弱验证类型，一个页面与另外一个页面只是在页脚显示的时间上有所不同，或者是展示的广告不相同，那么就会被认为是<strong>相同的</strong>。但是在使用强验证的情况下，二者是<strong>不同的</strong>。构建应用于弱验证类型的标签（etag）体系可能会比较复杂，因为这会涉及到对页面上不同的元素的重要性进行排序，但是会对缓存性能优化相当有帮助。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="条件首部">条件首部<a class="hash-link" href="#条件首部" title="标题的直接链接">​</a></h2><p>一些被称为条件首部的 HTTP 首部，可以引发条件请求。它们是：</p><ul><li><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Match" target="_blank" rel="noopener noreferrer"><code>If-Match</code></a></p><p>如果远端资源的实体标签与在 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/ETag" target="_blank" rel="noopener noreferrer"><code>ETag</code></a> 这个首部中列出的值相同的话，表示条件匹配成功。默认地，除非实体标签带有 &#x27;W/&#x27; 前缀，否者它将会执行强验证。</p></li><li><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-None-Match" target="_blank" rel="noopener noreferrer"><code>If-None-Match</code></a></p><p>如果远端资源的实体标签与在 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/ETag" target="_blank" rel="noopener noreferrer"><code>ETag</code></a> 这个首部中列出的值都不相同的话，表示条件匹配成功。默认地，除非实体标签带有 &#x27;W/&#x27; 前缀，否者它将会执行强验证。</p></li><li><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Modified-Since" target="_blank" rel="noopener noreferrer"><code>If-Modified-Since</code></a></p><p>如果远端资源的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Last-Modified" target="_blank" rel="noopener noreferrer"><code>Last-Modified</code></a> 首部标识的日期比在该首部中列出的值要更晚，表示条件匹配成功。</p></li><li><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Unmodified-Since" target="_blank" rel="noopener noreferrer"><code>If-Unmodified-Since</code></a></p><p>如果远端资源的 HTTPHeader(&quot;Last-Modified&quot;)}} 首部标识的日期比在该首部中列出的值要更早或相同，表示条件匹配成功。</p></li><li><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Range" target="_blank" rel="noopener noreferrer"><code>If-Range</code></a></p><p>与 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Match" target="_blank" rel="noopener noreferrer"><code>If-Match</code></a> 或 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Unmodified-Since" target="_blank" rel="noopener noreferrer"><code>If-Unmodified-Since</code></a> 相似，但是只能含有一个实体标签或者日期值。如果匹配失败，则条件请求宣告失败，此时将不会返回 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/206" target="_blank" rel="noopener noreferrer"><code>206</code></a> <code>Partial Content</code> 响应码，而是返回 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/200" target="_blank" rel="noopener noreferrer"><code>200</code></a> <code>OK</code> 响应码，以及完整的资源。</p></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="应用场景">应用场景<a class="hash-link" href="#应用场景" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="缓存更新">缓存更新<a class="hash-link" href="#缓存更新" title="标题的直接链接">​</a></h3><p>条件式请求最常见的应用场景是更新缓存。假如缓存为空，或者是没有缓存的话，被请求资源会以状态码 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/200" target="_blank" rel="noopener noreferrer"><code>200</code></a> <code>OK </code>返回。</p><p><img loading="lazy" alt="The request issued when the cache is empty triggers the resource to be downloaded, with both validator value sent as headers. The cache is then filled." src="/assets/images/cache1-2aa36118a477ec8740c0ce5e143c738e.png" width="741" height="265" class="img_ev3q"></p><p>验证器会同资源一起返回，它们出现在首部字段中。在这个例子中， <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Last-Modified" target="_blank" rel="noopener noreferrer"><code>Last-Modified</code></a> 与 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/ETag" target="_blank" rel="noopener noreferrer"><code>ETag</code></a> 都被返回，不过如果只返回其中的一个也是可以的。这些验证器会同资源一起被缓存起来（与所有的首部一样），并在在缓存失效的时候用来发起条件式请求。</p><p>只要缓存未失效，就不会发起任何请求。但是一旦失效——主要是由 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Cache-Control" target="_blank" rel="noopener noreferrer"><code>Cache-Control</code></a> 首部控制——客户端就不会采用缓存值而是发起条件式请求。验证器的值会用作 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Modified-Since" target="_blank" rel="noopener noreferrer"><code>If-Modified-Since</code></a> 和 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Match" target="_blank" rel="noopener noreferrer"><code>If-Match</code></a> 首部字段的参数。</p><p>假如资源未发生变化，服务器就返回状态码为 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/304" target="_blank" rel="noopener noreferrer"><code>304</code></a> <code>Not Modified</code> 的响应。这样相当于对缓存资源进行了刷新，而客户端则采用被缓存的资源。尽管这里有一次请求/响应往返会消耗一定的资源，但是这样做比将整个资源通过网络再传输一遍更高效。</p><p><img loading="lazy" alt="With a stale cache, the conditional request is sent. The server can determine if the resource changed, and, as in this case, decide not to send it again as it is the same." src="/assets/images/httpcache2-482e8bfa27d4ca69d0e9bf4993ee2244.png" width="741" height="265" class="img_ev3q"></p><p>假如资源发生了变化，服务器就直接返回 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/200" target="_blank" rel="noopener noreferrer"><code>200</code></a><code> OK</code> 响应码，连同新版本的资源，就像是没有应用条件式请求一样；客户端则采用新版本资源（并将其缓存起来）。</p><p><img loading="lazy" alt="In the case where the resource was changed, it is sent back as if the request wasn&amp;#39;t conditional." src="/assets/images/httpcache3-1c51410513377dd0bf8ecad631f5160e.png" width="741" height="265" class="img_ev3q"></p><p>除了需要在服务器端对验证器进行设置以外，该机制是透明的：所有的浏览器都会对缓存资源进行管理，在不需要 Web 开发者进行任何特殊处理的情况下发送条件式请求。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="增量下载的完整性">增量下载的完整性<a class="hash-link" href="#增量下载的完整性" title="标题的直接链接">​</a></h3><p>文件的增量下载是 HTTP 协议规定的一项功能，它允许恢复先前的操作，通过保存先前已经获得的信息来节省带宽和时间：</p><p><img loading="lazy" alt="A download has been stopped and only partial content has been retrieved." src="/assets/images/httpresume1-9e758fdeda9d271da0a5e062ee7c8941.png" width="764" height="397" class="img_ev3q"></p><p>支持增量下载的服务器会通过 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept-Ranges" target="_blank" rel="noopener noreferrer"><code>Accept-Ranges</code></a> 首部来广播这项能力。此后客户端就可以通过发送 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Range" target="_blank" rel="noopener noreferrer">Ranges (en-US)</a> 首部字段以及缺失的范围值来进行断点续传了：</p><p><img loading="lazy" alt="The client resumes the requests by indicating the range he needs and preconditions checking the validators of the partially obtained request." src="/assets/images/httpresume2-780f1315a3f0805d71974eeca4584858.png" width="771" height="307" class="img_ev3q"></p><p>基本原理很简单，但是这里有一个潜在的问题：如果要下载的资源在两次下载之间进行了修改，得到的数据范围就会对应该资源的两个不同的版本，那么最终获得的文件是损坏的。</p><p>为了防止这种情况的发生，需要使用条件式请求。对于范围请求来说，有两种方法可以实现这个目的。更灵活一些的方法是使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Modified-Since" target="_blank" rel="noopener noreferrer"><code>If-Modified-Since</code></a> 和 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Match" target="_blank" rel="noopener noreferrer"><code>If-Match</code></a> 首部，假如前置条件失败，服务器端会返回错误提示，然后客户端可以从头开始重新下载资源：</p><p><img loading="lazy" alt="When the partially downloaded resource has been modified, the preconditions will fail and the resource will have to be downloaded again completely." src="/assets/images/httpresume3-fa66ee1d4c3f3ff7e028c0bab27eab89.png" width="771" height="372" class="img_ev3q"></p><p>尽管这种方法行得通，但是它在文件发生变化的情况下增加了一次额外的请求/响应往返。这一点会影响性能。为此 HTTP 协议规定了一个特定的首部—— <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Range" target="_blank" rel="noopener noreferrer"><code>If-Range</code></a> ——来避免这种情况的发生：</p><p><img loading="lazy" alt="The If-Range headers allows the server to directly send back the complete resource if it has been modified, no need to send a 412 error and wait for the client to re-initiate the download." src="/assets/images/httpresume4-8470f94016d74a943196574dc1ffec9a.png" width="770" height="263" class="img_ev3q"></p><p>该方法更高效，但是缺乏一定的灵活性，因为条件值只能是实体标签。不过这种额外的灵活性很少会需要。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="使用乐观锁避免更新丢失问题">使用乐观锁避免更新丢失问题<a class="hash-link" href="#使用乐观锁避免更新丢失问题" title="标题的直接链接">​</a></h3><p>对于 Web 应用的一项常见操作是远程更新文件。这在各种类型的文件系统以及版本控制软件中都很常见，但是任何允许远程存储资源的软件也都需要这样一个乐观锁机制。常见的 Web 站点，例如 wiki 系统或其他类型的内容管理系统（CMS），都存在这样的需求。</p><p>使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/PUT" target="_blank" rel="noopener noreferrer"><code>PUT</code></a> 方法可以实现上述机制。客户端首先读取原始文件，然后进行修改，最后将它们推送到服务器上：</p><p><img loading="lazy" alt="Updating a file with a PUT is very simple when concurrency is not involved." src="/assets/images/httplock1-2a380aacb1c3b4a826ba757d940d7e09.png" width="744" height="421" class="img_ev3q"></p><p>不幸的是，当把并发情况考虑在内的时候，事情变得有些不那么确定。当一个客户端在本地修改它新获得的资源副本的时候，另外一个客户端同样可以获取一份资源副本并进行同样的操作。接下来要发生的事情就不那么顺利了：当二者提交回服务器的时候，前一个客户端作出的修改会被第二个客户端的推送所覆盖，因为第二个客户端对于第一个客户端做出的修改一无所知。最终的结果则取决于获胜的一方，但是该结果不会通知给另一方。哪一个客户端作出的修改将会被保存下来，会由于它们提交的速度而有所不同；提交的速度则依赖于客户端及服务器端的性能，甚至是使用客户端进行编辑的人的表现。每一次的胜出者都会有所不同。这种情况被称作竞态条件（race condition ），会导致难以捉摸的情况的发生，并且难以探测和除错：</p><p><img loading="lazy" alt="When several clients update the same resource in parallel, we are facing a race condition: the slowest win, and the others don&amp;#39;t even know they lost. Problematic!" src="/assets/images/httplock2-cb6a230cbef51605de088f53ef56dac5.png" width="904" height="504" class="img_ev3q"></p><p>不存在解决这一问题而不打扰双方某一方的办法。然而，更新丢失问题以及竞态条件是需要避免的。我们希望获得可预测的结果，并且希望在更新操作被拒绝的时候客户端可以得到反馈。</p><p>条件式请求可以被用在<strong>乐观锁算法</strong>（大多数 wiki 系统和版本管理系统采用的是该算法）的实现上。其思路是，允许所有的客户端获得资源的副本，然后在本地进行编辑，通过只允许第一个客户端成功提交的方式来控制并发操作。其余的基于现今已过期版本的更新操作都会被拒绝：</p><p><img loading="lazy" alt="Conditional requests allow to implement optimistic locking: now the quickest wins, and the others get an error." src="/assets/images/httplock3-a5abddd21c8d6cfe47815d09539107f3.png" width="904" height="471" class="img_ev3q"></p><p>这种方式的实现需要用到 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Match" target="_blank" rel="noopener noreferrer"><code>If-Match</code></a> 或 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Unmodified-Since" target="_blank" rel="noopener noreferrer"><code>If-Unmodified-Since</code></a> 首部。假如实体标签与源头文件的实体标签不一致，或者源头文件在被获取副本之后经过了修改，那么此次变更请求就会被拒绝，收到 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/412" target="_blank" rel="noopener noreferrer"><code>412</code></a> <code>Precondition Failed</code> 的错误提示。之后就需要依靠客户端来处理该错误了：或者通知用户重新开始（基于最新的版本），或者是给用户展示两个版本之间的<strong>差异</strong>，辅助他们决定要保留哪些变更。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="处理资源的首次上传问题">处理资源的首次上传问题<a class="hash-link" href="#处理资源的首次上传问题" title="标题的直接链接">​</a></h3><p>资源的首次上传问题是前面所描述的情况的一个极端情况。与任何资源更新问题一样，当两个客户端在大致相同的时间进行上传操作的时候，就会遇到竞态条件。为了防止这种情况的发生，可以使用条件式请求：添加 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-None-Match" target="_blank" rel="noopener noreferrer"><code>If-None-Match</code></a> 首部，并将其值设置为<code>&#x27;*&#x27;</code>, 表示任意实体标签。当且仅当资源先前并不存在的情况下请求的操作才会成功执行：</p><p><img loading="lazy" alt="Like for a regular upload, the first upload of a resource is subject to a race condition: If-None-Match can prevent it." src="/assets/images/httpfirst-2dd0e93e91eebc961a3b4e1349eb7c72.png" width="895" height="311" class="img_ev3q"></p><p><code>If-None-Match</code> 首部只可应用于兼容 HTTP/1.1（及后续版本）的服务器。假如不确定所访问的服务器是否兼容，需要首先向要访问的资源发送一次 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/HEAD" target="_blank" rel="noopener noreferrer"><code>HEAD</code></a> 请求来进行确认。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="结语">结语<a class="hash-link" href="#结语" title="标题的直接链接">​</a></h2><p>条件式请求是 HTTP 协议中一项非常重要的特性，它使高效复杂的应用系统的构建得以实现。对于缓存或断点续传功能来说，站点管理员只需要正确配置服务器就可以了；在某些环境中设置正确的实体标签可能需要一些技巧。但一旦设置成功，浏览器就能够按照预期地发送条件式请求。</p><p>而对于锁机制，则恰恰相反：Web 开发者需要使用合适的消息首部生成请求，另一方面，站点管理员在大多时候可以依赖应用来检查这些首部信息。</p><p>显然在两种情况下，条件式请求都发挥着基础性作用，成为 Web 应用的有力支撑。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/http">HTTP</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/protocol">protocol</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/条件请求">条件请求</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/conditional-requests">conditional_requests</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/yuanyp8/yuanyp8.github.io/tree/master/docs/http/15-conditionalRequests.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">最后<!-- -->由 <b>yuanyp8</b> <!-- -->于 <b><time datetime="2022-07-22T10:03:09.000Z">2022年7月22日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/http/compression"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">HTTP 协议中的数据压缩</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/http/content_negotiation"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">内容协商</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#基本原理" class="table-of-contents__link toc-highlight">基本原理</a></li><li><a href="#验证器" class="table-of-contents__link toc-highlight">验证器</a><ul><li><a href="#强验证类型" class="table-of-contents__link toc-highlight">强验证类型</a></li><li><a href="#弱验证类型" class="table-of-contents__link toc-highlight">弱验证类型</a></li></ul></li><li><a href="#条件首部" class="table-of-contents__link toc-highlight">条件首部</a></li><li><a href="#应用场景" class="table-of-contents__link toc-highlight">应用场景</a><ul><li><a href="#缓存更新" class="table-of-contents__link toc-highlight">缓存更新</a></li><li><a href="#增量下载的完整性" class="table-of-contents__link toc-highlight">增量下载的完整性</a></li><li><a href="#使用乐观锁避免更新丢失问题" class="table-of-contents__link toc-highlight">使用乐观锁避免更新丢失问题</a></li><li><a href="#处理资源的首次上传问题" class="table-of-contents__link toc-highlight">处理资源的首次上传问题</a></li></ul></li><li><a href="#结语" class="table-of-contents__link toc-highlight">结语</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/category/docker-cookbook">Docker Cookbook</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/category/http-protocol">HTTP 权威指南</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">博客</a></li><li class="footer__item"><a href="https://github.com/yuanyp8/yuanyp8.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Yuanyp8's Project, Stay Hungry Stay Foolish.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.47731b22.js"></script>
<script src="/assets/js/main.6c8dd19e.js"></script>
</body>
</html>